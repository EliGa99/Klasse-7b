<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Umfragen</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#20d1e1">

<style>
  body { font-family: Arial; margin:0; background:#f5f5f5; }
  header {
    background: linear-gradient(90deg,#20d1e1,#8a2be2);
    padding:20px; color:white; text-align:center;
    font-size:26px; font-weight:bold;
  }
  main {
    max-width:700px; margin:30px auto; background:white;
    padding:20px; border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
  }
  input, button, textarea {
    width:100%; padding:10px; margin-top:10px;
    border-radius:8px; border:1px solid #ccc; font-size:16px;
  }
  button {
    background:#20d1e1; color:white; border:none; cursor:pointer;
  }
  button:hover { background:#18b5c3; }
  .optionRow {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  align-items: center;
}

.optionRow input {
  flex: 1;
}

.optionRow button {
  flex: 0;
  width: 40px;
  background: #ff4d4d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

  .barOuter { width:100%; background:#ddd; height:12px; border-radius:10px; margin-top:5px; }
  .barInner { height:12px; background:#20d1e1; border-radius:10px; width:0%; }
</style>
</head>
<body>

<header>Umfragen</header>

<main>
  <div id="content">Lade…</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, getDoc,
  serverTimestamp, query, where
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAPY-RoptoqTUHdZwb9oMyF3Etsk3Qju2s",
  authDomain: "klassen-website-5283c.firebaseapp.com",
  projectId: "klassen-website-5283c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const content = document.getElementById("content");
let currentUser = null;

/* -------------------------------
   LOGIN CHECK
-------------------------------- */
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "login.html";

  currentUser = user;

  const userDoc = await getDoc(doc(db, "users", user.uid));
  const role = userDoc.exists() ? userDoc.data().role : "student";

  if (role === "teacher") showTeacherUI();
  else showStudentUI();
});

/* -------------------------------
   LEHRER UI
-------------------------------- */
function showTeacherUI() {
  content.innerHTML = `
    <h2>Neue Umfrage erstellen</h2>

    <label>Frage:</label>
    <textarea id="question" placeholder="Frage eingeben..."></textarea>

    <h3>Antwortmöglichkeiten</h3>
    <div id="options"></div>
    <button id="addOptionBtn">+ Option hinzufügen</button>

    <label style="margin-top:20px;">
      <input type="checkbox" id="multi"> Mehrfachauswahl erlauben
    </label>

    <button id="createBtn">Umfrage erstellen</button>

    <h2 style="margin-top:40px;">Bestehende Umfragen</h2>
    <div id="surveyList">Lade…</div>
  `;

  const optionsDiv = document.getElementById("options");
  const addOptionBtn = document.getElementById("addOptionBtn");

  function addOptionField() {
    const row = document.createElement("div");
    row.className = "optionRow";
    row.innerHTML = `
      <input type="text" placeholder="Antwortoption">
      <button onclick="this.parentElement.remove()">X</button>
    `;
    optionsDiv.appendChild(row);
  }

  addOptionBtn.onclick = addOptionField;
  addOptionField();
  addOptionField();

  document.getElementById("createBtn").onclick = createSurvey;

  loadSurveysForTeacher();
}

/* -------------------------------
   LEHRER: UMFRAGE SPEICHERN
-------------------------------- */
async function createSurvey() {
  const question = document.getElementById("question").value.trim();
  const multi = document.getElementById("multi").checked;

  const optionInputs = [...document.querySelectorAll("#options input")];
  const options = optionInputs.map(i => i.value.trim()).filter(v => v !== "");

  if (!question || options.length < 2) {
    alert("Bitte Frage und mindestens 2 Optionen eingeben.");
    return;
  }

  await addDoc(collection(db, "surveys"), {
    question,
    options,
    multi,
    createdBy: currentUser.uid,
    createdAt: serverTimestamp()
  });

  alert("Umfrage erstellt!");
  showTeacherUI();
}

/* -------------------------------
   LEHRER: UMFRAGEN LADEN
-------------------------------- */
async function loadSurveysForTeacher() {
  const list = document.getElementById("surveyList");
  list.innerHTML = "";

  const snap = await getDocs(collection(db, "surveys"));

  for (const s of snap.docs) {
    const data = s.data();

    const votesSnap = await getDocs(
      query(collection(db, "surveyVotes"), where("surveyId", "==", s.id))
    );

    const counts = Array(data.options.length).fill(0);
    votesSnap.docs.forEach(v => {
      const arr = v.data().optionIndex;
      arr.forEach(i => counts[i]++);
    });

    const total = counts.reduce((a,b)=>a+b,0);

    let bars = "";
    data.options.forEach((opt, i) => {
      const percent = total ? Math.round((counts[i]/total)*100) : 0;
      bars += `
        <p><b>${opt}</b> – ${counts[i]} Stimmen (${percent}%)</p>
        <div class="barOuter"><div class="barInner" style="width:${percent}%"></div></div>
      `;
    });

    list.innerHTML += `
      <div class="surveyBox">
        <h3>${data.question}</h3>
        ${bars}
      </div>
    `;
  }
}

/* -------------------------------
   SCHÜLER UI
-------------------------------- */
async function showStudentUI() {
  content.innerHTML = `<h2>Umfragen</h2><div id="surveyList">Lade…</div>`;

  const list = document.getElementById("surveyList");
  list.innerHTML = "";

  const snap = await getDocs(collection(db, "surveys"));

  for (const s of snap.docs) {
    const data = s.data();

    const voteSnap = await getDocs(
      query(collection(db, "surveyVotes"),
      where("surveyId", "==", s.id),
      where("userId", "==", currentUser.uid))
    );

    const alreadyVoted = voteSnap.size > 0;

    let optionsHtml = "";
    data.options.forEach((opt, i) => {
      const type = data.multi ? "checkbox" : "radio";
      optionsHtml += `
        <label>
          <input name="opt_${s.id}" type="${type}" value="${i}">
          ${opt}
        </label><br>
      `;
    });

    list.innerHTML += `
      <div class="surveyBox">
        <h3>${data.question}</h3>

        ${alreadyVoted ? "<i>Du hast bereits abgestimmt.</i>" : `
          ${optionsHtml}
          <button onclick="vote('${s.id}', ${data.multi})">Abstimmen</button>
        `}
      </div>
    `;
  }
}

/* -------------------------------
   SCHÜLER: ABSTIMMEN
-------------------------------- */
window.vote = async function(surveyId, multi) {
  const inputs = [...document.querySelectorAll(`input[name="opt_${surveyId}"]`)];
  let selected = [];

  inputs.forEach(i => { if (i.checked) selected.push(Number(i.value)); });

  if (selected.length === 0) {
    alert("Bitte eine Option auswählen.");
    return;
  }

  await addDoc(collection(db, "surveyVotes"), {
    surveyId,
    userId: currentUser.uid,
    optionIndex: selected,
    timestamp: serverTimestamp()
  });

  alert("Danke für deine Stimme!");
  showStudentUI();
};

/* -------------------------------
   SERVICE WORKER
-------------------------------- */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
